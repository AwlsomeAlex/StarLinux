################################
#                              #
# Star Package Manager Library #
#                              #
################################
# Created by AwlsomeAlex [GPLv3]
# Heavily Inspired by Ivandavidov's common.sh for Overlays
# Compatible with StarOS & Star Library

#############
# Variables #
#############

export START_DIR="$(pwd)"
export REPO_DIR="/tmp/spm/repo"
export STAR_DIR="/tmp/nebula"
export WORK_DIR="/tmp/nebula/work"
export SRC_DIR="/tmp/nebula/source"
export FINAL_DIR="/tmp/nebula/final"
export JOB_FACTOR=2
export CFLAGS="-Os -s -fno-stack-protector -fomit-frame-pointer -U_FORTIFY_SOURCE"
export NUM_CORES="$(grep ^processor /proc/cpuinfo | wc -l)"
export NUM_JOBS="$((NUM_CORES * JOB_FACTOR))"

RD='\033[1;31m'
GN='\033[1;32m'
YW='\033[1;33m'
BL='\033[1;34m'
NC='\033[0m'


#############
#           #
# Functions #
#           #
#############


############
# Messages #
############

warning_msg() {
	MESSAGE=$1
	echo ""
	echo "==================="
	echo -e "| ${RD}!!! WARNING !!! ${NC}|"
	echo "==================="
	echo $MESSAGE
	echo ""
}

download_msg() {
	echo -e "${BL}(****) Downloading and Extracting $PACKAGE...${NC}"	
}

download_done_msg() {
	echo -e "${GN}(DONE) Downloading and Extracting $PACKAGE.${NC}"
}

build_msg() {
	echo -e "${BL}(****) Building $PACKAGE...${NC}"
}

build_done_msg() {
	echo -e "${GN}(DONE) Built $PACKAGE...${NC}"
}





function dependent() {
	PACKAGE=$1
	TICK=$2
	if [[ $TICK == "SPM" ]]; then
		echo "Checking SPM Dependency $PACKAGE..."
		if [[ $PACKAGE == "nebula" ]]; then
			if [ ! -d $STAR_DIR ]; then
				echo -e "${RD}ERROR: The Nebula Directories could not be found. Please run 'spm build nebula' to generate them!${NC}"
				exit 0
			fi
		else
			if [ ! -d $WORK_DIR/$PACKAGE ]; then
				echo -e "${RD}ERROR: Dependency '$PACKAGE' is missing. Please build it with 'spm build $PACKAGE'.${NC}"
				exit 0
			fi
		fi
	elif [[ $TICK == "Host" ]]; then
		warning_msg "THIS WILL REQUIRE SUPERUSER ACCESS FOR USE OF THE PROGRAM 'apt'!!!"
		sudo apt install $PACKAGE
	else
		echo -e "${RD}ERROR: No TICK defined.${NC}"
		exit 0
	fi
}

function download() {
	## Created by AwlsomeAlex [GNU GPLv3]
	## User-Friendly and Noise-Free Downloader powered by wget
	## Modified for easy download of StarOS Packages
	LINK=$1
	FILE=$2
	if [[ $LINK == "" ]]; then
		echo -e "${RD}WARNING: A Download Link was not provided.${NC}"

	else
		wget -P $FILE $LINK -q --show-progress
		#wget $LINK -c $FILE -q --show-progress
	fi
}

function extract() {
	FILE=$1
	NAME=$2
	
	if [ -d $WORK_DIR/$NAME ]; then
		rm -rf $WORK_DIR/$NAME
	fi
	mkdir -p $WORK_DIR/$NAME
	tar -xvf $FILE -C $WORK_DIR/$NAME
}

