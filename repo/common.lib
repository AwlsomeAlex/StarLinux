#########################################
#---------------------------------------#
# Star Package Builder - Common Library #
#---------------------------------------#
#########################################
# Created by AwlsomeAlex [GNU GPLv3]
# Heavily Inspired by Ivandavidov's common.sh for Overlays


#############
# Functions #
#############

# message: Display a custom color-coded message for User Output and Debugging
function message() (
  option=$1
  message=$2
  if [ "$option" = "" ]; then
    echo -e "${RC}Usage: message [option] [message]"
    echo -e "Option: ...., DONE, WARN, ERROR"
    echo -e "Message: Display Text for Certain Messages${NC}"
  elif [ "$option" = "...." ]; then
    echo -e "${BL}(****) ${NC} $message"
  elif [ "$option" = "DONE" ]; then
    echo -e "${GN}(DONE) ${NC} $message"
  elif [ "$option" = "WARN" ]; then
		echo ""
		echo "==============="
		echo -e "| ${RD} !!! WARNING !!! ${NC} |"
		echo "==============="
		echo $message
	elif [ "option" = "ERROR" ]; then
		echo ""
		echo "==============="
		echo -e "| ${RD} !!! ERROR !!! ${NC} |"
		echo "==============="
		echo $message
		echo ""
		exit 72
  else
    echo -e "${RC}Usage: message [option] [message]"
    echo -e "Option: ...., DONE, WARN, ERROR"
    echo -e "Message: Display Text for Certain Messages${NC}"
  fi
)

# download: Downloads a file from the SPM Repository
function download() (
	## Created by AwlsomeAlex [GNU GPLv3]
	## User-Friendly and Noise-Free Downloader powered by wget
	link=$1
  file=$2
	if [ "$link" = "" ]; then
		echo -e "${RD}Usage: download [link] [file]${NC}"
	else
		wget -P $file $link -q --show-progress
	fi
)

# read_config: Reads the Master Configuration File included with the Downloaded SPB Repository
function read_config() (
  var_name=$1
  var_value=
  if [ ! "$var_name" = "" ]; then
    var_value="`grep -i ^${var_name}= $CONFIG_FILE | cut -f2- -d'=' | xargs`"
  else
    message ERROR "read_config: Variable Name not defined!"
  fi
  if [ "$var_value" = "" ]; then
    message ERROR "read_config: Variable $var_name returned no value!"
  fi
  echo "$var_value"
)

# depends: Checks if a dependency package is built
function depends() (
	package=$1
	if [ "$package" = "Protostar" ]; then
		if [ ! -d $MAIN_DIR ]; then
			message ERROR "The Protostar Directory could not be found! Please run 'spb build protostar' to generate them!"
		fi
	elif [ ! -d $WORK_DIR/$package* ]; then
		message ERROR "Dependency '$package' is missing! Please build it with 'spb build $package'."
	fi
)

# download_source: Downloads a Source Tarball of a package
function download_source() (
	package=$1
	download "`read_config $package`-LINK" $SRC_DIR
)

#############
# Variables #
#############
export REPO_LINK="https://github.com/AwlsomeAlex/StarLinux/archive/protostar.zip" # Allows for Custom Repositories
export REPO_DIR="/tmp/spm/repo" # Only Directory NOT configured in Main Configuration
export CONFIG_FILE="$REPO_DIR/starlinux.config" # Can change StarLinux to another file for Custom Configuration Files
export MAIN_DIR="`read_config MAIN_DIR`"
export WORK_DIR="`read_config WORK_DIR`"
export SRC_DIR="`read_config SRC_DIR`"
export FINAL_DIR="`read_config FINAL_DIR`"
JOB_FACTOR="`read_config JOB_FACTOR`"
NUM_CORES="$(grep ^processor /proc/cpuinfo | wc -l)"
export NUM_JOBS="$((NUM_CORES * JOB_FACTOR))"
export CFLAGS="`read_config CFLAGS`"
export VERSION="`read_config VERSION`"
export BUILD_NUMBER="`read_config BUILD_NUMBER`"
export CODENAME="`read_config CODENAME`"

RD='\033[1;31m'
GN='\033[1;32m'
YW='\033[1;33m'
BL='\033[1;34m'
NC='\033[0m'
